# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
#

trigger:
  branches:
    include:
    - main
    - releases/*
pr:
  - main
  - releases/*

pool:
  vmImage: 'ubuntu-latest'

resources:
  containers:
    - container: 'ubuntu18.04-gcc11-conan2-doxygen1.9.6'
      image: 'mattgomes28/cpp-ubuntu-bionic:0.7'
      options: '--user 0:0'

stages:

- stage: failfast
  displayName: FailFast Checks
  jobs:
  - job: failfast
    displayName: Failfast Scripts
    container: 'ubuntu18.04-gcc11-conan2-doxygen1.9.6'
    continueOnError: false
    steps:
    - bash: scripts/shellcheck.sh
      displayName: Linting Shell
      workingDirectory: $(Build.SourcesDirectory)
    - bash: scripts/cpp-lint.sh
      displayName: Linting CPP files
      workingDirectory: $(Build.SourcesDirectory)

- stage: 'build'
  displayName: 'Build Project'
  dependsOn:
    - failfast
  jobs:
  - job: 'build_x86_64_debug'
    displayName: Ubuntu Debug Build
    container: 'ubuntu18.04-gcc11-conan2-doxygen1.9.6'
    continueOnError: 'false'
    steps:
      - bash: scripts/helpers/conan-install.sh Debug
        displayName: 'Installing all Conan dependencies'
        workingDirectory: $(Build.SourcesDirectory)

      - bash: |
          set -euo pipefail
          scripts/build_x86-64.sh unix-deb -DBUILD_DOCS="On"
          mkdir -p "$(Build.SourcesDirectory)/artifacts"
          tar -zcf "$(Build.SourcesDirectory)/artifacts/build-x86_64-deb.tar.gz" "build/" 
        displayName: 'Compile Code & Tests'
        workingDirectory: $(Build.SourcesDirectory)

      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: "$(Build.SourcesDirectory)/artifacts"
          artifactName: 'DebBuildFiles'

  - job: 'build_x86_64_release'
    displayName: Ubuntu Release Build
    container: 'ubuntu18.04-gcc11-conan2-doxygen1.9.6'
    continueOnError: 'false'
    steps:
      - bash: scripts/helpers/conan-install.sh Release
        displayName: 'Installing all Conan dependencies'
        workingDirectory: $(Build.SourcesDirectory)

      - bash: |
          set -euo pipefail
          scripts/build_x86-64.sh unix-rel -DBUILD_DOCS="On"
          mkdir -p "$(Build.SourcesDirectory)/artifacts"
          tar -zcf "$(Build.SourcesDirectory)/artifacts/build-x86_64-rel.tar.gz" "build/" 
        displayName: 'Compile Code & Tests'
        workingDirectory: $(Build.SourcesDirectory)

      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: "$(Build.SourcesDirectory)/artifacts"
          artifactName: 'RelBuildFiles'

  - job: 'build_win_x64_debug'
    displayName: Windows Debug Build
    pool:
      vmImage: 'windows-2022'
    continueOnError: 'false'
    steps:
      - pwsh: .\scripts\helpers\conan-install.ps1 -BuildType Debug
        displayName: 'Installing all Conan dependencies'
        workingDirectory: $(Build.SourcesDirectory)

      - pwsh: |
          .\scripts\build_win_x64.ps1 -Preset "vs2022-deb"
          if(!$?) { Exit $LASTEXITCODE }
          New-Item -ItemType Directory -Force -Path "$(Build.SourcesDirectory)/artifacts"
          7z a -ttar "$(Build.SourcesDirectory)/artifacts/build_win_64_deb.tar"  "build/"
          if(!$?) { Exit $LASTEXITCODE }
          7z a -tgzip "$(Build.SourcesDirectory)/artifacts/build_win_64_deb.tar.gz" "$(Build.SourcesDirectory)/artifacts/build_win_64_deb.tar"
          if(!$?) { Exit $LASTEXITCODE }
        displayName: 'Compile Code & Tests'
        workingDirectory: $(Build.SourcesDirectory)
        failOnStderr: true

      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: "$(Build.SourcesDirectory)/artifacts"
          artifactName: 'WinDebBuildFiles'

  - job: build_win_x64_release
    displayName: Windows Release Build
    pool:
      vmImage: 'windows-2022'
    continueOnError: 'false'
    steps:
      - pwsh: .\scripts\helpers\conan-install.ps1 -BuildType Release
        displayName: 'Installing all Conan dependencies'
        workingDirectory: $(Build.SourcesDirectory)

      - pwsh: |
          .\scripts\build_win_x64.ps1 -Preset "vs2022-rel"
          if(!$?) { Exit $LASTEXITCODE }
          New-Item -ItemType Directory -Force -Path "$(Build.SourcesDirectory)/artifacts"
          7z a -ttar "$(Build.SourcesDirectory)/artifacts/build_win_64_rel.tar"  "build/"
          if(!$?) { Exit $LASTEXITCODE }
          7z a -tgzip "$(Build.SourcesDirectory)/artifacts/build_win_64_rel.tar.gz" "$(Build.SourcesDirectory)/artifacts/build_win_64_rel.tar"
          if(!$?) { Exit $LASTEXITCODE }
        displayName: 'Compile Code & Tests'
        workingDirectory: $(Build.SourcesDirectory)
        failOnStderr: true

      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: "$(Build.SourcesDirectory)/artifacts"
          artifactName: 'WinRelBuildFiles'

- stage: docs
  displayName: Build Documentation
  dependsOn:
    - build
  jobs:
  - job:
    container: ubuntu18.04-gcc11-conan2-doxygen1.9.6
    displayName: Build Doxygen CMake
    steps:
      - checkout: self
        submodules: recursive
      - bash: scripts/helpers/conan-install.sh
        displayName: 'Installing all Conan dependencies'
        workingDirectory: $(Build.SourcesDirectory)

      - task: DownloadPipelineArtifact@2
        displayName: Download Built Files
        inputs:
          source: current
          artifact: 'DebBuildFiles'
          path: "$(Build.SourcesDirectory)/artifacts"

      - bash: |
          set -euo pipefail
          tar -xzf "artifacts/build-x86_64-deb.tar.gz"
          cd "build/unix-deb" && cmake --build . --target=doxygen_build
          mkdir -p "$(Build.SourcesDirectory)/artifacts"
          tar -zcf "$(Build.SourcesDirectory)/artifacts/docs.tar.gz" "docs" 
        displayName: 'Building The Doxygen Target'
        workingDirectory: $(Build.SourcesDirectory)
      
      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: "$(Build.SourcesDirectory)/artifacts"
          artifactName: 'DocsFiles'

- stage: tests
  displayName: Running Tests
  dependsOn:
    - build
  jobs:
  - job:
    container: ubuntu18.04-gcc11-conan2-doxygen1.9.6
    displayName: Running CTest
    steps:
      - checkout: none
      - task: DownloadPipelineArtifact@2
        displayName: Download Built Files
        inputs:
          source: current
          artifact: DebBuildFiles
          path: "$(Build.SourcesDirectory)/artifacts"

      - bash: |
          set -euo pipefail
          tar -xzf "artifacts/build-x86_64-deb.tar.gz"
          cd "build/unix-deb" && ctest --verbose --test-dir="build/unix-deb"
        displayName: Running All Tests
        workingDirectory: $(Build.SourcesDirectory)

- stage: static_analysis
  displayName: Static Analysis
  dependsOn:
    - build
  jobs:
  - job:
    container: ubuntu18.04-gcc11-conan2-doxygen1.9.6
    displayName: Running Clang-Tidy
    steps:
      - checkout: self
      - task: DownloadPipelineArtifact@2
        displayName: Download Built Files
        inputs:
          source: current
          artifact: DebBuildFiles
          path: $(Build.SourcesDirectory)/artifacts
      - bash: scripts/helpers/conan-install.sh
        displayName: Installing all Conan dependencies
        workingDirectory: $(Build.SourcesDirectory)
      - bash: |
          set -euo pipefail
          tar -xzf "artifacts/build-x86_64-deb.tar.gz"
          ./scripts/static-analysis.sh
        displayName: Running Clang-Tidy script
        workingDirectory: $(Build.SourcesDirectory)
